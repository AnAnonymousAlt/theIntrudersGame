<!DOCTYPE html>

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  </head>
  <body>
    <div style="position: relative;">
      <canvas id="gamearea_background" width="480" height="360"
        style="position: absolute; left:0; top: 0; z-index: 0;"></canvas>
      <canvas id="gamearea_front" width="480" height="360" 
        style="position: absolute; left:0; top: 0; z-index: 1;"></canvas>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    
    <script>
      var socket = io();
      window.onload = function() {
        gameStart();
      };
      var myid = -1;
      function gameStart() {
        socket.emit("gamestart");
        socket.on("approve", function(msg){
          myid = msg;
          console.log(myid);
        });
        game.load();
      }
      var game = {
        background_canvas : document.getElementById("gamearea_background"),
        front_canvas : document.getElementById("gamearea_front"),
        interval : 100,
        load: function() {
          game.background_context = game.background_canvas.getContext("2d");
          game.front_context = game.front_canvas.getContext("2d");
          game.player = drawComponent(10,10,50,50,"blue");
          var bg_img = new Image();
          bg_img.onload = function() {
            game.background_context.drawImage(bg_img, 0, 0, 480, 360);
          }
          bg_img.src = "/pic/bg0.jpg";
          window.setInterval(updateGame, game.interval);
	  $( document ).ready(function() {
          window.addEventListener("keydown", function (e) {
            game.keys = (game.keys || []);
            game.keys[e.keyCode] = true;
            console.log("down" + e.keyCode + "game.key[] == " + game.keys[e.keyCode]);
          });
          window.addEventListener("keyup", function (e) {
            game.keys[e.keyCode] = false;
            console.log("up" + e.keyCode + "game.key[] == " + game.keys[e.keyCode]);
          });
          });
        },
        clear : function() {
          // console.log("clear");
          this.front_context.clearRect(0,0, 480, 360);
        }        
      }

      function drawComponent(x, y, width, height, color) {
        this.width = width;
        this.height = height;
        this.x = x;
        this.y = y;
        this.color = color;

        this.speedX = 0;
        this.speedY = 0;
        this.acceleration = 0.3;
        this.move = function() {
          if (game.keys && game.keys[87]) {
            this.speedY = this.speedY + this.acceleration;
          }
        
          if (game.keys && game.keys[83]) {
            this.speedY = this.speedY - this.acceleration;
          }
          if (game.keys && game.keys[65]) {
            this.speedX = this.speedX - this.acceleration;
          }
          if (game.keys && game.keys[68]) {
            this.speedX = this.speedX + this.acceleration;
          }
          if (this.speedY > 2) {
            this.speedY = 2;
          }
          if (this.speedY < -2) {
            this.speedY = -2;
          }
          if (this.speedX > 2) {
            this.speedX = 2;
          }
          if (this.speedX < -2) {
            this.speedX = -2;
          }
          if (game.keys && game.keys[32]) {
            this.speedX = 0;
            this.speedY = 0;
          }
        }
        this.updatePos = function() {
          // console.log("pos");
          this.x += this.speedX;
          this.y += this.speedX;
          if (this.x + this.width > 480) {
            this.x = 480 - this.width;
            this.speedX = 0;
          }
          if (this.x < 0) {
            this.x = 0;
            this.speedX = 0;
          }
          if (this.y + this.height > 360) {
            this.y = 360 - this.height;
            this.speedY = 0;
          }
          if (this.y < 0) {
            this.y = 0;
            this.speedY = 0;
          }
        }

        this.draw = function() {
          // console.log("draw");
          game.front_context.fillStyle = color;
          game.front_context.fillRect(this.x, this.y, this.width, this.height);
        }
        return this;
      }

      function updateGame() {
        // console.log("update");
        game.clear();
        game.player.move();
        game.player.updatePos();
        game.player.draw();
      }

    </script>
  </body>
</html>
