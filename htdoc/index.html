<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
      canvas {
        // border: 5px solid #ff0000;
        // background-color: #fddd33;
      }
    </style>
  </head>
  <body onload="startGame()">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket = io();
    </script>
    <script>
	    function uuid() {
  var uuid = "", i, random;
  for (i = 0; i < 32; i++) {
    random = Math.random() * 16 | 0;

    if (i == 8 || i == 12 || i == 16 || i == 20) {
      uuid += "-"
    }
    uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
  }
  return uuid;
}
      var canvasWidth = 480;
      var canvasHeight = 480;
      var myGamePiece1; // myGP1
      //var myGamePieceBackground; // myGPBgd
      var getPermission = 0;
      var myid = -1;
      var bg_img;
      /*
      socket.on('new_user', function(msg) {
      });
      */
      var boss; 

      socket.on('accept', function(msg) {
        myid = msg;
      });
      // inital drawComponent and start myGameArea (canvas)
      function startGame() {
        myGameArea.start();
	myGamePiece1 = new drawComponent(30,30,"red",10,120);
	boss = new picComponent("boss.jpeg", 50,50, 120, 220);
	   var uuidv1s = uuid() + "";
	socket.emit("gamestart", uuidv1s);
	// myGamePiece1 = new drawComponent(30,30,"red",10,120);
	// myGamePieceBackground = new drawComponent(300,220,"grey",130,50);
      }
      // main object
      var myGameArea = {
        canvas : document.createElement("canvas"),
        start : function() {
          this.canvas.width = canvasWidth;
          this.canvas.height = canvasHeight;
          this.context = this.canvas.getContext("2d");
          document.body.insertBefore(this.canvas, document.body.childNodes[0]);
	  // load background img
	  bg_img = new Image();
	  var tempcontext = this.context;
	  bg_img.onload = function() {
	    tempcontext.drawImage(bg_img,0,0,480, 480);
	  }
	  bg_img.src = "background.jpeg";
          this.interval = setInterval(updateGameArea, 20);
          window.addEventListener('keydown', function (e) {
            myGameArea.key = e.keyCode;
          });
          window.addEventListener('keyup', function (e) {
            myGameArea.key = false;
          });
        },
        // clear whole canvas
        clear : function() {
          this.context.clearRect(0,0,this.canvas.width,this.canvas.height);
	  this.context.drawImage(bg_img,0,0,480, 480);
        }
      }

      // type of pic object. draw from local pic, size, pos
      function picComponent(path, width, height, x, y) {
	this.width = width;
	this.height = height;
	this.x = x;
	this.y = y;
	this.speedX = 0;
	this.speedY = 0;
	this.img = new Image();
	this.img.src = path;
	this.update = function() {
	  var ctx = myGameArea.context;
	  ctx.drawImage(this.img, this.x, this.y, this.width, this.height);
	}
      }

      // type of draw object. draw with size, color and pos
      function drawComponent(width, height, color, x, y) {
        this.width = width;
        this.height = height;
        this.x = x;
        this.y = y;
        this.color = color;
        this.speedX = 0;
        this.speedY = 0;
        // update location
        this.update = function () {
          var ctx = myGameArea.context;
          ctx.fillStyle = color;
          ctx.fillRect(this.x, this.y, this.width, this.height);
        }
        this.newPos = function() {
          // (FIXED) BUG: check the situation that x + width + speed > border, x + width = border
          if (this.speedX > 0) {
            // if it is not at the border
            if (this.x + this.width < canvasWidth) {
              // if it will go over the border
              if (this.x + this.width + this.speedX > canvasWidth) {
                this.x = canvasWidth - this.width;
              }
              // add speed
              else {
                this.x += this.speedX;
              }
            }
            // at the border
            else {
              this.speedX = 0;
              //this.x = this.x;
            }
          }
          // speed to the left
          else if (this.speedX < 0) {
            // if it is inside the border
            if (this.x > 0) {
              // if it goes outside the border
              if (this.x + this.speedX < 0) {
                this.x = 0;
              }
              // add speed
              else {
                this.x += this.speedX;
              }
            }
            // at the border
            else {
              this.speedX = 0;
              // this.x = this.x;
            }
          }
          // speed = 0
          else {
            // this.x = this.x;
          }
          // Y
          // if speed is downwards
          if (this.speedY > 0) {
            // if it is inside the border
            if (this.y + this.height < canvasHeight) {
              // if it cross over the border
              if (this.y + this.height + this.speedY > canvasHeight) {
                this.y = canvasHeight - this.height;
              }
              // add speed
              else {
                this.y += this.speedY;
              }
            }
            // on the border
            else {
              this.speedY = 0;
              // this.y = this.y;
            }
          }
          // if speed is upwards
          else if (this.speedY < 0) {
            // if it is inside the border
            if (this.y > 0) {
              // if it is going to cross over the border
              if (this.y + this.speedY < 0) {
                this.y = 0;
              }
              // add speed
              else {
                this.y += this.speedY;
              }
            }
            // on the border
            else {
              this.speedY
              //this.y = this.y;
            }
          }
          // speed = 0
          else {
            //this.y = this.y;
          }
        }
      }
      var ts = 0.5; // turn round speed
      var sl = 3; // speed limit
      var av = 0.3; // accelerated speed


      function updateGameArea() {
	if (myid == -1) return;
        // Clear then update
        //myGameArea.clear();
        var oldx = myGamePiece1.x;
        var oldy = myGamePiece1.y;
        // Make piece move. 1 px / 20 millisecond towards right
        // myGamePiece1.x+=1;
        // Key sroke
        if (myGameArea.key && myGameArea.key == 32) {
          stopMove();
        }
        if (myGameArea.key && myGameArea.key == 87) {
          if (myGamePiece1.speedY > 0) {
            myGamePiece1.speedY -= ts;
          }
          else {
            myGamePiece1.speedY -= av;
          }
          if (myGamePiece1.speedY < 0 - sl) {
            myGamePiece1.speedY = 0 - sl;
          }
        }
        if (myGameArea.key && myGameArea.key == 83) {
          if (myGamePiece1.speedY < 0) {
            myGamePiece1.speedY += ts;
          }
          else myGamePiece1.speedY += av;
          if (myGamePiece1.speedY > sl) {
            myGamePiece1.speedY = sl
          }
        }
        if (myGameArea.key && myGameArea.key == 65) {
          if (myGamePiece1.speedX > 0) {
            myGamePiece1.speedX -= ts;
          }
          else {
            myGamePiece1.speedX -= av;
          }
          if (myGamePiece1.speedX < 0 - sl) {
            myGamePiece1.speedX = 0 - sl;
          }
        }
        if (myGameArea.key && myGameArea.key == 68) {
          if (myGamePiece1.speedX < 0) {
            myGamePiece1.speedX += ts;
          }
          else {
            myGamePiece1.speedX += av;
          }
          if (myGamePiece1.speedX > sl) {
            myGamePiece1.speedX = sl;
          }
        }

        // update
        // myGamePieceBackground.update();
        myGamePiece1.newPos();
        var newx = myGamePiece1.x;
        var newy = myGamePiece1.y;
	/*
        myGamePiece1.x = oldx;
        myGamePiece1.y = oldy;
	*/
        //myGamePiece1.update();
        
        var emit_message = {
          'x': newx, 'y': newy, 'id': myid
        } 
        socket.emit('update', emit_message);
      }
      var turn = 0;
      // msg is the location of all drawComponents
      socket.on('update', function(msg) {
	myGameArea.clear();
	// myGamePieceBackground.update();
	if (turn == 0) boss.x = boss.x+2;
	else boss.x = boss.x - 2;
	if (boss.x > 325) turn = 1;
	else if (boss.x < 120) turn = 0;
	boss.update();
        var i;
	for (i = 0; i < msg.length; i++) {
	  //if (i == myid) continue;
	  var ctx = myGameArea.context;
	  ctx.fillStyle = "red";
          if (myid == i) ctx.fillStyle = "blue";
          ctx.fillRect(msg[i].x, msg[i].y, 30, 30);
	}
	var x_d = Math.abs(msg[myid].x - boss.x);
	var y_d = Math.abs(msg[myid].y - boss.y);
	if (((x_d < 50 && msg[myid].x > boss.x) || (x_d < 30 && msg[myid].x < boss.x )) 
	  && ((y_d < 50 && msg[myid].y > boss.y) || (y_d < 30 && msg[myid].y < boss.y))) {
	    socket.emit('win');
	    socket.disconnect();
	    alert("You win!");
	}
      });
      socket.on('lose', function(msg) {
	socket.disconnet();
	alert("You loss!");
      });
      function moveUp() {
        myGamePiece1.speedY -= 1;
      }
      function moveDown() {
        myGamePiece1.speedY += 1;
      }
      function moveLeft() {
        myGamePiece1.speedX -= 1;
      }
      function moveRight() {
        myGamePiece1.speedX += 1;
      }
      function stopMove() {
        myGamePiece1.speedX = 0;
        myGamePiece1.speedY = 0;
      }
    </script>
    <p> Move to the boss to win!</p>
  </body>
</html>
